---
- name: Make sure mediawiki dir exists
  file: path=/home/mediawiki/{{mediawiki.host}}/w state=directory owner=www-data group=www-data

- name: Check out version {{mediawiki.version}} of mediawiki
  sudo_user: www-data
  git: repo=https://gerrit.wikimedia.org/r/mediawiki/core
       dest=/home/mediawiki/{{mediawiki.host}}/w version={{mediawiki.version}}

- name: Copy php-fpm pool configuration
  template: src=php.conf.j2 dest=/etc/php5/fpm/pool.d/{{mediawiki.host}}.conf
  notify: restart php-fpm

- name: Copy nginx site configuration
  template: src=nginx.conf.j2 dest=/etc/nginx/sites-available/{{mediawiki.host}}.conf
  notify: restart nginx

- name: Link nginx site configuration
  file: src=/etc/nginx/sites-available/{{mediawiki.host}}.conf path=/etc/nginx/sites-enabled/{{mediawiki.host}}.conf state=link
  notify: restart nginx

- name: Write mediawiki settings
  template: src=LocalSettings.php.j2 dest=/home/mediawiki/{{mediawiki.host}}/w/LocalSettings.php owner=www-data group=www-data mode=0644

- name: Download mediawiki extensions
  sudo_user: www-data
  command: git submodule update --init extensions/WikiEditor extensions/SyntaxHighlight_GeSHi extensions/CodeEditor extensions/Vector extensions/MobileFrontend
    chdir=/home/mediawiki/{{mediawiki.host}}/w

- name: Copy logo
  copy: src=logo.png dest=/home/mediawiki/{{mediawiki.host}}/w/logo.png owner=www-data group=www-data mode=0644
