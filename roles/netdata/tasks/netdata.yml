---
- name: install netdata upstart
  template: src=upstart.j2 dest=/etc/init/netdata.conf
  notify: restart netdata

- name: Write site
  template: src=netdata.conf.j2 dest={{ netdata_conf }}/netdata.conf
  notify: restart netdata

- name: Write site
  template: src=nginx.j2 dest=/etc/nginx/sites-available/01-{{ netdata_domain }}.conf
  notify: reload nginx

- name: Link site
  file: src=/etc/nginx/sites-available/01-{{ netdata_domain }}.conf dest=/etc/nginx/sites-enabled/01-{{ netdata_domain }}.conf state=link
  notify: reload nginx

- name: Ensure htpasswd directory
  file: path=/etc/nginx/htpasswd state=directory owner=www-data group=www-data mode=2775

- name: Create htpasswd file
  htpasswd: path=/etc/nginx/htpasswd/netdata name={{ netdata_user }} password={{ netdata_pass }} owner=root group=www-data mode=0640

- name: Generate SSL cert
  command: "{{ le_cmd }} -d {{ netdata_domain }}"
